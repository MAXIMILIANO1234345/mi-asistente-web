<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Blender (AI)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- El script de Supabase y la l贸gica JS se mueven al final del <body> -->
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <!-- Usando un placeholder corregido -->
            <img src="https://placehold.co/100x100/1e1e24/ff7a00?text=Blender" alt="Logo Asistente AI">
        </div>
        <h1>Asistente de Blender</h1>

        <!-- 1. Contenedor de AUTENTICACIN (LOGIN/REGISTRO) -->
        <div class="auth-container" id="authContainer">
            <h2>Bienvenido a la Comunidad Educativa</h2>
            
            <button id="toggleRegister">Quiero registrarme como estudiante</button>

            <form id="authForm">
                <!-- CAMPOS COMUNES (Ahora con atributo NAME) -->
                <input type="email" id="authEmail" name="authEmail" placeholder="Correo Electr贸nico" required>
                <input type="password" id="authPassword" name="authPassword" placeholder="Contrase帽a" required>

                <!-- CAMPOS ADICIONALES PARA EL REGISTRO (Ocultos por defecto) -->
                <div id="registerFields" style="display: none;">
                    
                    <hr style="margin: 10px 0;">
                    <label>Datos Personales y Contacto</label>
                    
                    <!-- CORRECCIN: Se a帽ade el atributo NAME a todos los campos -->
                    <input type="text" id="authNombreCompleto" name="authNombreCompleto" placeholder="Nombre Completo">
                    <input type="text" id="authRegion" name="authRegion" placeholder="Regi贸n/Pa铆s">
                    <input type="text" id="authInstitution" name="authInstitution" placeholder="Instituci贸n Educativa">
                    <input type="tel" id="authCelular" name="authCelular" placeholder="N煤mero de Celular">
                    <input type="tel" id="authWhatsApp" name="authWhatsApp" placeholder="N煤mero de WhatsApp (opcional)">

                    <hr style="margin: 10px 0;">
                    <label>Datos Educativos (Mejora del RAG)</label>
                    
                    <select id="authTemaInteres" name="authTemaInteres">
                        <option value="">Tema de Inter茅s Principal...</option>
                        <option value="Modelado_3D">Modelado 3D (Blender)</option>
                        <option value="Fisica">F铆sica Avanzada</option>
                        <option value="Matematicas">Matem谩ticas</option>
                        <option value="Otros">Otros</option>
                    </select>

                    <select id="authNivelEducativo" name="authNivelEducativo">
                        <option value="">Nivel Educativo Actual...</option>
                        <option value="Secundaria">Secundaria</option>
                        <option value="Bachillerato">Bachillerato/Prepa</option>
                        <option value="Universitario">Universitario</option>
                        <option value="Otro">Otro</option>
                    </select>

                    <hr style="margin: 10px 0;">
                    <label>Contexto Tecnol贸gico (Brecha Digital)</label>
                    
                    <select id="authDispositivo" name="authDispositivo">
                        <option value="">Dispositivo Principal...</option>
                        <option value="Smartphone">Smartphone</option>
                        <option value="Laptop_Antigua">Laptop (M谩s de 5 a帽os)</option>
                        <option value="PC_Escritorio">PC de Escritorio</option>
                    </select>

                    <select id="authVelocidadInternet" name="authVelocidadInternet">
                        <option value="">Velocidad de Internet...</option>
                        <option value="Lenta_Movil">Lenta (Datos M贸viles)</option>
                        <option value="Media_ADSL">Media (ADSL/Cable)</option>
                        <option value="Rapida_Fibra">R谩pida (Fibra ptica)</option>
                    </select>
                </div>
                
                <button type="submit" id="submitButton">Iniciar Sesi贸n</button>
            </form>
        </div>


        <!-- 2. Contenedor de la APLICACIN (CHAT) (Oculto por defecto) -->
        <div class="app-container" id="appContainer" style="display: none;">
            <div class="chat-window" id="chatWindow">
                <div class="message ai-message">
                    <strong>AI:</strong> 隆Hola! Soy tu asistente de Blender. Haz una pregunta sobre modelado, iluminaci贸n o animaci贸n para empezar.
                </div>
            </div>
            <textarea id="userQuestion" placeholder="Escribe tu pregunta sobre Blender aqu铆..."></textarea>
            <button id="sendButton">Enviar</button>
            <div class="loading-spinner" id="loadingSpinner"></div>
            <button id="logoutButton" style="margin-top: 15px;">Cerrar Sesi贸n</button>
        </div>
    </div>

    <!--  IMPORTANTE: Script de Supabase y la l贸gica van AQU -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        //  CONFIGURACIN DE SUPABASE (隆Tus claves ya est谩n puestas!)
        const SUPABASE_URL = 'https://faujkhrypihnaxqvnroc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhdWpraHJ5cGlobmF4cXZucm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMzM5ODgsImV4cCI6MjA3ODkwOTk4OH0.SR-OBag_SyIJrHwVG2M4MPrZmrb2ByjHjJpagAEAOoE';
        const API_URL = 'https://mi-backend-ia-2.onrender.com/preguntar';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Elementos de la Interfaz ---
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const authForm = document.getElementById('authForm');
        const registerFields = document.getElementById('registerFields');
        const submitButton = document.getElementById('submitButton');
        const toggleRegisterButton = document.getElementById('toggleRegister');
        const logoutButton = document.getElementById('logoutButton');
        const chatWindow = document.getElementById('chatWindow');
        const userQuestionInput = document.getElementById('userQuestion');
        const sendButton = document.getElementById('sendButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // --- Inputs de Autenticaci贸n ---
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');

        // --- Inputs del Formulario de Perfil (Alumnos) ---
        const authNombreCompletoInput = document.getElementById('authNombreCompleto');
        const authRegionInput = document.getElementById('authRegion');
        const authInstitutionInput = document.getElementById('authInstitution');
        const authCelularInput = document.getElementById('authCelular');
        const authWhatsAppInput = document.getElementById('authWhatsApp');
        const authTemaInteresInput = document.getElementById('authTemaInteres');
        const authNivelEducativoInput = document.getElementById('authNivelEducativo');
        const authDispositivoInput = document.getElementById('authDispositivo');
        const authVelocidadInternetInput = document.getElementById('authVelocidadInternet');
        
        let currentSessionId = null;

        // --- Listado de campos de registro para control din谩mico ---
        const registrationInputs = [
            authNombreCompletoInput,
            authRegionInput,
            authInstitutionInput,
            authCelularInput,
            authTemaInteresInput,
            authNivelEducativoInput,
            authDispositivoInput,
            authVelocidadInternetInput
        ];


        // ------------------------------------------------------------------
        // --- FUNCIONES DE SEGURIDAD ---
        // ------------------------------------------------------------------

        // Funci贸n de sanitizaci贸n para prevenir XSS en los inputs de texto
        function sanitizeInput(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .trim();
        }

        // ------------------------------------------------------------------
        // --- FUNCIONES DE AUTENTICACIN ---
        // ------------------------------------------------------------------

        function toggleFormMode(isRegister) {
            if (isRegister) {
                // MODO REGISTRO: Habilitar campos y validaci贸n (SOLUCIN al error 'not focusable')
                registerFields.style.display = 'block';
                registrationInputs.forEach(input => input.setAttribute('required', 'required'));

                submitButton.textContent = 'Registrarme';
                toggleRegisterButton.textContent = 'Ya tengo una cuenta, quiero iniciar sesi贸n';
            } else {
                // MODO LOGIN: Deshabilitar campos y validaci贸n
                registerFields.style.display = 'none';
                registrationInputs.forEach(input => input.removeAttribute('required'));

                submitButton.textContent = 'Iniciar Sesi贸n';
                toggleRegisterButton.textContent = 'Quiero registrarme como estudiante';
            }
        }
        
        async function signUpStudent(email, password) {
            // 1. Sanitizaci贸n de datos de texto
            const cleanedNombreCompleto = sanitizeInput(authNombreCompletoInput.value);
            const cleanedRegion = sanitizeInput(authRegionInput.value);
            const cleanedInstitution = sanitizeInput(authInstitutionInput.value);
            const cleanedCelular = sanitizeInput(authCelularInput.value);
            const cleanedWhatsApp = sanitizeInput(authWhatsAppInput.value);

            // 2. Crear la cuenta de usuario en Supabase Auth
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email: email,
                password: password
            });

            if (authError) {
                alert('Error en el registro de cuenta: ' + authError.message);
                return false;
            }
            
            const userId = authData.user.id;

            // 3. Insertar los datos completos y sanitizados en la tabla 'perfiles'
            const { error: profileError } = await supabase
                .from('perfiles')
                .insert({
                    id: userId,
                    email_perfil: email, 
                    nombre_completo: cleanedNombreCompleto,
                    institucion: cleanedInstitution,
                    region: cleanedRegion,
                    celular: cleanedCelular,
                    whatsapp: cleanedWhatsApp || null,
                    es_profesor: false, 
                    tema_interes: authTemaInteresInput.value,
                    nivel_educativo: authNivelEducativoInput.value,
                    dispositivo_acceso: authDispositivoInput.value,
                    velocidad_internet: authVelocidadInternetInput.value
                });

            if (profileError) {
                console.error('Error al guardar el perfil:', profileError);
                alert('Error al guardar el perfil. Contacte al administrador. ' + profileError.message);
                return false;
            }

            alert('隆Registro exitoso! Revisa tu correo electr贸nico para confirmar tu cuenta y luego inicia sesi贸n.');
            return true;
        }

        async function signInUser(email, password) {
            const { error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                alert('Error al iniciar sesi贸n: Credenciales incorrectas, o cuenta no confirmada/autorizada.');
                return false;
            }

            checkAuthentication();
            return true;
        }

        async function signOutUser() {
            await supabase.auth.signOut();
            currentSessionId = null;
            checkAuthentication();
            alert('Sesi贸n cerrada.');
        }

        async function checkAuthentication() {
            const { data: { user } } = await supabase.auth.getUser();
            const session = (await supabase.auth.getSession()).data.session;
            
            if (user && session) {
                // Seguridad: Verificar que el perfil exista y el rol sea v谩lido
                const { data: perfil, error } = await supabase
                    .from('perfiles')
                    .select('es_profesor')
                    .eq('id', user.id)
                    .single();

                if (error || !perfil) {
                    console.error("Perfil no encontrado o rol inv谩lido.");
                    await signOutUser();
                    return;
                }
                
                // Si la autenticaci贸n es exitosa y el perfil v谩lido, ir directamente a la IA (CHAT)
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                logoutButton.style.display = 'block'; 
                
                if (!currentSessionId) {
                    currentSessionId = crypto.randomUUID();
                }

            } else {
                // Muestra el formulario de autenticaci贸n
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                logoutButton.style.display = 'none';
                toggleFormMode(false);
            }
        }

        // ------------------------------------------------------------------
        // --- FUNCIONES DE CHAT (HISTORIAL) ---
        // ------------------------------------------------------------------

        function parsearRespuesta(texto) {
            const regex = /\[Imagen relevante disponible en: (https?:\/\/[^\s]+)\]/g;
            return texto.replace(regex, (match, url) => {
                return `<br><a href="${url}" target="_blank" title="Haz clic para ver la imagen completa">
                            <img src="${url}" alt="Imagen del Manual" class="chat-image">
                        </a>`;
            });
        }

        async function sendMessage() {
            const question = userQuestionInput.value.trim();
            const session = await supabase.auth.getSession();
            
            if (!question || !session.data.session) {
                checkAuthentication();
                alert("Debes iniciar sesi贸n para usar el asistente.");
                return;
            }

            const token = session.data.session.access_token;
            const userId = session.data.session.user.id;
            const sanitizedQuestion = sanitizeInput(question); 

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.innerHTML = `<strong>T煤:</strong> ${sanitizedQuestion}`; 
            chatWindow.appendChild(userMessageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            userQuestionInput.value = '';
            sendButton.disabled = true;
            loadingSpinner.classList.add('active');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pregunta: sanitizedQuestion, 
                        user_id: userId,
                        session_id: currentSessionId
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Error en la API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai-message';

                let htmlRespuesta = '<strong>AI:</strong>';

                if (data.respuesta_principal) {
                    const parrafoPrincipal = parsearRespuesta(data.respuesta_principal.replace(/\n/g, '<br>'));
                    htmlRespuesta += `<p>${parrafoPrincipal}</p>`;
                }
                
                if (data.puntos_clave && data.puntos_clave.length > 0) {
                    htmlRespuesta += '<ul>';
                    for (const punto of data.puntos_clave) {
                        const descripcion = parsearRespuesta(punto.descripcion.replace(/\n/g, '<br>'));
                        htmlRespuesta += `<li><strong>${punto.titulo}:</strong> ${descripcion}</li>`;
                    }
                    htmlRespuesta += '</ul>';
                }

                if (data.fuente) {
                    htmlRespuesta += `<p class="fuente"><em>Fuente: ${data.fuente}</em></p>`;
                }

                aiMessageDiv.innerHTML = htmlRespuesta;
                chatWindow.appendChild(aiMessageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;

            } catch (error) {
                console.error("Error al obtener respuesta de la IA:", error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'message ai-message';
                errorMessageDiv.innerHTML = `<strong>AI:</strong> Lo siento, hubo un error al procesar tu solicitud. (${error.message})`;
                chatWindow.appendChild(errorMessageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;

            } finally {
                sendButton.disabled = false;
                loadingSpinner.classList.remove('active');
            }
        }

        // ------------------------------------------------------------------
        // --- ASIGNACIN DE EVENTOS Y START ---
        // ------------------------------------------------------------------

        sendButton.addEventListener('click', sendMessage);
        userQuestionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        authForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitButton.disabled = true;

            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            
            if (submitButton.textContent === 'Registrarme') {
                await signUpStudent(email, password);
                toggleFormMode(false); 
            } else {
                await signInUser(email, password);
            }
            
            submitButton.disabled = false;
        });

        toggleRegisterButton.addEventListener('click', () => {
            const isRegisterMode = (submitButton.textContent !== 'Registrarme');
            toggleFormMode(isRegisterMode);
        });

        logoutButton.addEventListener('click', signOutUser);

        // Inicializaci贸n: Verificar la sesi贸n al cargar la p谩gina
        checkAuthentication();

    </script>
</body>
</html>
